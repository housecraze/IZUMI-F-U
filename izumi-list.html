<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>IG Follow-Up Tracker</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Share+Tech+Mono&display=swap');
    
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      height: 100%;
      background: #000;
      color: #0ff;
      font-family: 'Share Tech Mono', monospace;
      overflow-x: hidden;
      touch-action: manipulation;
    }
    body {
      background: linear-gradient(135deg, #000 0%, #111 50%, #222 100%);
      padding: 8px;
    }

    #topBar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(12px);
      padding: 10px 12px;
      z-index: 9999;
      border-bottom: 1px solid #333;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    #searchInput, #limitInput {
      flex: 1;
      min-width: 120px;
      padding: 10px 12px;
      background: #111;
      border: 1px solid #0ff;
      color: #0ff;
      border-radius: 8px;
      font-size: 14px;
    }
    #searchBtn {
      padding: 10px 16px;
      background: #0ff;
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
    }

    h2 {
      text-align: center;
      margin: 70px 0 10px;
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      color: #0ff;
      text-shadow: 0 0 15px #0ff;
      letter-spacing: 2px;
    }

    #userList {
      margin: 10px 0 200px 0;
      max-height: 45vh;
      overflow-y: auto;
      padding: 0 4px;
    }
    .user-row {
      background: rgba(0,255,255,0.05);
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      border: 1px solid rgba(0,255,255,0.2);
      transition: all 0.2s;
      cursor: pointer;
    }
    .user-row.highlight {
      background: rgba(0,255,255,0.25) !important;
      border: 1px solid #0ff;
      box-shadow: 0 0 15px rgba(0,255,255,0.4);
    }
    .username {
      flex: 1;
      font-weight: bold;
      color: #0ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .status {
      font-size: 11px;
      color: #888;
      background: #222;
      padding: 3px 8px;
      border-radius: 6px;
    }

    #navControls {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.97);
      backdrop-filter: blur(15px);
      padding: 12px;
      border-top: 1px solid #333;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #currentUsername {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      text-align: center;
      color: #0ff;
      text-shadow: 0 0 10px #0ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 8px;
      background: rgba(0,255,255,0.1);
      border-radius: 10px;
      border: 1px dashed #0ff;
    }
    .nav-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    .nav-row button {
      flex: 1;
      padding: 16px;
      font-size: 18px;
      background: #111;
      border: 2px solid #0ff;
      color: #0ff;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
    }
    .nav-row button:active {
      background: #0ff;
      color: #000;
    }

    label input[type="checkbox"] {
      transform: scale(4.5);
      accent-color: #0ff;
      cursor: pointer;
    }

    #floatingCounter {
      position: fixed;
      bottom: 170px;
      right: 20px;
      width: 70px;
      height: 70px;
      background: #000;
      color: #0ff;
      font-size: 32px;
      font-weight: bold;
      border: 4px solid #0ff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      box-shadow: 0 0 20px #0ff;
      transition: all 0.3s;
    }
    #floatingCounter.red {
      background: #8B0000;
      border-color: #ff0000;
      color: #fff;
      box-shadow: 0 0 30px #ff0000;
      transform: scale(1.1);
    }
    #floatingCounter.green {
      background: #008000;
      border-color: #006400;
      color: #fff;
      box-shadow: 0 0 30px #006400;
      transform: scale(1.1);
    }

    #toast {
      position: fixed;
      bottom: 250px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,255,255,0.2);
      color: #0ff;
      padding: 12px 24px;
      border-radius: 10px;
      border: 1px solid #0ff;
      font-size: 16px;
      z-index: 99999;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
    }
    #toast.show { opacity: 1; }

    #igStatusBox {
      width: 18px; height: 18px;
      border-radius: 50%;
      background: gray;
      border: 2px solid #fff;
      display: inline-block;
    }

    .top-btn {
      padding: 8px 10px;
      background: transparent;
      border: 1px solid #555;
      color: #aaa;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      cursor: pointer;
    }
    .top-btn.primary {
      background: #0ff;
      color: #000;
      font-weight: bold;
      border-color: #0ff;
    }
  </style>
</head>
<body>

<div id="topBar">
  <input type="text" id="searchInput" placeholder="Search user">
  <input type="number" id="limitInput" placeholder="Acc limit" style="width:90px;">
  <button id="searchBtn">Go</button>
  <button class="top-btn" onclick="copyCheckboxStates()">Copy</button>
  <button class="top-btn" onclick="pushToSheet(); resetCounter()">Reset</button>
  <button class="top-btn" onclick="generateList()">Fetch</button>
  <button class="top-btn primary" onclick="runNextContainer()">Next Cont</button>
</div>

<h2>IG Follow-Up Tracker</h2>
<div id="userList">Click "Fetch" to load data</div>

<div id="navControls">
  <div id="currentUsername">‚Äî</div>
  
  <div class="nav-row">
    <button onclick="prevUser(); pushToSheet(); openCurrentIG()">Prev</button>
    <label><input type="checkbox" id="currentCheckbox"></label>
    <button onclick="nextUser(); pushToSheet(); openCurrentIG()">Next</button>
  </div>

  <div class="nav-row">
    <button onclick="window.open('https://instagram.com','_blank')">Open IG</button>
    <button onclick="checkIG()">Check IG</button>
    <span id="igStatusBox"></span>
    <button onclick="openCurrentIG()">Go IG</button>
  </div>
</div>

<div id="floatingCounter">0</div>
<div id="toast">Ready</div>

<script>
// ‚öôÔ∏è CONFIGURATION - PASTE YOUR GOOGLE SCRIPT WEB APP URL HERE
const RAW_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpAxnSpjDBN4jpxJQ0feZgz7g29e5tH_S3-vO2gijuJIlQaVHv2cqBeiR7D3VoqA8r/exec";
const SCRIPT_URL = "https://corsproxy.io/?" + encodeURIComponent(RAW_SCRIPT_URL);

let currentUsers = [];
let checkboxStates = {};
let currentIndex = 0;
let counterValue = 0;
const countedNavChecks = new Set();
const countedSet = new Set();

const listContainer = document.getElementById("userList");
const currentNameEl = document.getElementById("currentUsername");
const currentCheckbox = document.getElementById("currentCheckbox");
const counterEl = document.getElementById("floatingCounter");

// Search functionality
document.getElementById("searchBtn").onclick = () => {
  const query = document.getElementById("searchInput").value.trim().toLowerCase();
  if (!query) return;
  const found = currentUsers.findIndex(u => u.username?.toLowerCase().includes(query));
  if (found !== -1) {
    currentIndex = found;
    localStorage.setItem("currentIndex", currentIndex);
    updateCurrentView();
    toast(`‚Üí ${currentUsers[currentIndex].username}`);
  } else {
    toast("Not found");
  }
};

document.getElementById("searchInput").addEventListener("keypress", e => {
  if (e.key === "Enter") document.getElementById("searchBtn").click();
});

// Next container shortcut (iOS Shortcuts integration)
function runNextContainer() {
  window.location.href = "shortcuts://run-shortcut?name=IG%20Switch";
}

// Fetch data from Google Sheets
async function generateList() {
  if (!RAW_SCRIPT_URL || RAW_SCRIPT_URL === "PASTE_YOUR_DEPLOYMENT_URL_HERE") {
    listContainer.innerHTML = '<p style="color:red;">‚ö†Ô∏è Please configure RAW_SCRIPT_URL in the code</p>';
    toast("Configure API URL first!");
    return;
  }

  listContainer.innerHTML = "Fetching...";
  let users = [];
  
  try {
    const timestamp = new Date().getTime();
    const urlWithCache = `${RAW_SCRIPT_URL}?t=${timestamp}`;
    const proxiedUrl = "https://corsproxy.io/?" + encodeURIComponent(urlWithCache);
    
    const res = await fetch(proxiedUrl, {
      method: "GET"
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    users = await res.json();
    
  } catch (e) {
    listContainer.innerHTML = `<p style="color:red;">Failed: ${e.message}</p>`;
    toast("Failed to fetch data");
    return;
  }

  if (!users?.length) {
    listContainer.innerHTML = "<p>No data found</p>";
    return;
  }

  listContainer.innerHTML = "";
  currentUsers = users;
  checkboxStates = {};
  countedSet.clear();

  users.forEach((user, i) => {
    const row = document.createElement("div");
    row.className = "user-row";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.dataset.index = i;
    cb.checked = !!user.checked;
    checkboxStates[i] = !!user.checked;

    cb.addEventListener("change", () => {
      checkboxStates[i] = cb.checked;
      if (cb.checked && !countedSet.has(i)) {
        counterValue++;
        countedSet.add(i);
      } else if (!cb.checked && countedSet.has(i)) {
        counterValue--;
        countedSet.delete(i);
      }
      updateCounter();
    });

    const name = document.createElement("span");
    name.className = "username";
    name.textContent = user.username || "???";

    const status = document.createElement("span");
    status.className = "status";
    status.textContent = user.status || "";

    const btn = document.createElement("button");
    btn.textContent = "IG";
    btn.style.cssText = "padding:4px 8px;font-size:11px;background:#111;border:1px solid #0ff;color:#0ff;border-radius:4px;cursor:pointer";
    btn.onclick = (e) => {
      e.stopPropagation();
      window.open(`https://instagram.com/${user.username}`, "_blank");
    };

    row.appendChild(cb);
    row.appendChild(btn);
    row.appendChild(name);
    row.appendChild(status);
    listContainer.appendChild(row);

    row.onclick = (e) => {
      if (e.target.tagName !== "INPUT" && e.target.tagName !== "BUTTON") {
        currentIndex = i;
        localStorage.setItem("currentIndex", i);
        updateCurrentView();
      }
    };
  });

  currentIndex = Math.min(parseInt(localStorage.getItem("currentIndex")) || 0, users.length - 1);
  updateCurrentView();
  updateCounter();
  toast("Data loaded!");
}

// Scroll to active user
function scrollToActiveUser() {
  const activeRow = document.querySelector(`.user-row input[data-index="${currentIndex}"]`)?.closest(".user-row");
  if (activeRow) {
    activeRow.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

// Update current view
function updateCurrentView() {
  const user = currentUsers[currentIndex];
  currentNameEl.textContent = user?.username || "‚Äî";
  currentCheckbox.checked = !!checkboxStates[currentIndex];
  
  document.querySelectorAll(".user-row").forEach(r => r.classList.remove("highlight"));
  const row = document.querySelector(`.user-row input[data-index="${currentIndex}"]`)?.closest(".user-row");
  if (row) row.classList.add("highlight");
  
  scrollToActiveUser();
}

// Navigate to next user (skip those with "Skip" status)
function nextUser() {
  if (!currentUsers.length) return;
  let start = currentIndex;
  do {
    currentIndex = (currentIndex + 1) % currentUsers.length;
  } while (currentUsers[currentIndex].status === "Skip" && currentIndex !== start);
  
  if (currentUsers[currentIndex].status === "Skip") currentIndex = start;
  localStorage.setItem("currentIndex", currentIndex);
  updateCurrentView();
  setTimeout(openCurrentIG, 150);
}

// Navigate to previous user
function prevUser() {
  if (!currentUsers.length) return;
  let start = currentIndex;
  do {
    currentIndex = currentIndex <= 0 ? currentUsers.length - 1 : currentIndex - 1;
  } while (currentUsers[currentIndex].status === "Skip" && currentIndex !== start);
  
  if (currentUsers[currentIndex].status === "Skip") currentIndex = start;
  localStorage.setItem("currentIndex", currentIndex);
  updateCurrentView();
  setTimeout(openCurrentIG, 150);
}

// Open current user's Instagram
function openCurrentIG() {
  const user = currentUsers[currentIndex];
  if (user?.username) {
    window.open(`https://instagram.com/${user.username}`, "_blank");
  }
}

// Handle checkbox change
currentCheckbox.onchange = () => {
  const checked = currentCheckbox.checked;
  checkboxStates[currentIndex] = checked;
  
  const listBox = document.querySelector(`.user-row input[data-index="${currentIndex}"]`);
  if (listBox) listBox.checked = checked;
  
  if (checked && !countedNavChecks.has(currentIndex)) {
    counterValue++;
    countedNavChecks.add(currentIndex);
  } else if (!checked && countedNavChecks.has(currentIndex)) {
    counterValue--;
    countedNavChecks.delete(currentIndex);
  }
  updateCounter();
};

// Update counter display
function updateCounter() {
  const limit = parseInt(document.getElementById("limitInput").value || "0");
  counterEl.textContent = counterValue;
  counterEl.classList.remove("red", "green");
  
  if (limit > 0 && counterValue >= limit) {
    counterEl.classList.add("red");
  }
}

// Push changes back to Google Sheets
async function pushToSheet() {
  if (!RAW_SCRIPT_URL || RAW_SCRIPT_URL === "PASTE_YOUR_DEPLOYMENT_URL_HERE") {
    toast("Configure API URL first!");
    return;
  }

  const updates = currentUsers.map((u, i) => ({
    username: u.username,
    checked: !!checkboxStates[i],
    row: i + 2
  }));

  try {
    const proxiedUrl = "https://corsproxy.io/?" + encodeURIComponent(RAW_SCRIPT_URL);
    const res = await fetch(proxiedUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updates)
    });
    
    if (res.ok) {
      toast("‚úÖ Synced");
    } else {
      throw new Error("Sync failed");
    }
  } catch (e) {
    toast("‚ùå Sync failed");
    console.error(e);
  }
}

// Copy checkbox states to clipboard
function copyCheckboxStates() {
  const txt = currentUsers.map((u, i) => checkboxStates[i] ? "TRUE" : "FALSE").join("\n");
  navigator.clipboard.writeText(txt).then(() => toast("üìã Copied!"));
}

// Reset counter
function resetCounter() {
  counterValue = 0;
  countedNavChecks.clear();
  countedSet.clear();
  updateCounter();
  toast("Counter reset");
}

// Toast notification
function toast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.className = "show";
  setTimeout(() => t.className = "", 2500);
}

// Check if Instagram account exists
async function checkIG() {
  const box = document.getElementById("igStatusBox");
  box.style.backgroundColor = "gray";

  const username = currentUsers[currentIndex]?.username?.trim();
  if (!username) {
    box.style.backgroundColor = "red";
    return;
  }

  try {
    const res = await fetch(`https://www.instagram.com/api/v1/users/web_profile_info/?username=${username}`, {
      method: "GET",
      headers: {
        "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1",
        "X-IG-App-ID": "936619743392459",
        "X-Requested-With": "XMLHttpRequest",
        "Accept": "*/*"
      }
    });

    if (res.status === 200) {
      const data = await res.json();
      box.style.backgroundColor = data?.data?.user?.id ? "lime" : "red";
    } else {
      box.style.backgroundColor = "red";
    }
  } catch (e) {
    box.style.backgroundColor = "red";
  }
}

// Initialize counter on load
updateCounter();
</script>
</body>
</html>
